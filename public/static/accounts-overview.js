$(document).ready(function(){(function(){var pathname=window.location.pathname;var dd=!1;var navbar=$('#navbar');navbar.find('a.dropdown-item').each(function(i,el){if($(el).attr("href")===pathname){$(el).addClass('active');$(el).closest('li.nav-item').addClass('active');dd=!0;return!1}});if(dd===!0)return;navbar.find('li.nav-item').each(function(i,el){var a=$(el).find('a:first');if(a.attr("href")===pathname){$(el).addClass('active');return!1}})})()});function getData(k){var data=JSON.parse(sessionStorage.getItem('data'));return data[k]}
function setData(k,d){var data;if(sessionStorage.getItem('data')===null)data={};else data=JSON.parse(sessionStorage.getItem('data'));data[k]=d;sessionStorage.setItem('data',JSON.stringify(data))}
function isJson(item){item=typeof item!=="string"?JSON.stringify(item):item;try{item=JSON.parse(item)}catch(e){return!1}
if(typeof item==="object"&&item!==null){return!0}
return!1}
function getAJAX(model,logic,toScript,fromAjax,timeout,disableOverlay){var timerStart=Date.now();if(!disableOverlay)$('#overlay').show();return $.ajax({url:'routerAjax.php',type:'POST',data:{model:model,logic:logic,toScript:toScript,fromAjax:fromAjax},dataType:'html',cache:!1,timeout:timeout}).fail(function(res){console.log(res);console.log('AJAX Error')}).always(function(res){if(!disableOverlay)$('#overlay').hide();console.log('AJAX Time: '+(Date.now()-timerStart))})}
function getColorArray(){return['#4572A7','#AA4643','#0ba828','#80699B','#3D96AE','#DB843D','#92A8CD','#A47D7C','#B5CA92',"#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"]}
function getDataTablesOptions(){var o={iDisplayLength:15,dom:"<'row'<'col-sm-12 col-md-6'B><'col-sm-12 col-md-6'f>>"+"<'row'<'col-sm-12 px-0'tr>>"+"<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",buttons:['copy','csv','excel',],language:{search:"Search a lag value:",info:"_START_ - _END_ (_TOTAL_ total rows)"},columnDefs:[{}],order:[0,"asc"],pagingType:"full_numbers"};return o}
function getHighChartsOptions(){var o={chart:{style:{fontFamily:'inherit'},},title:{style:{fontFamily:'inherit'}}};return o}
function arrayColumn(array,columnName){return array.map(function(value,index){return value[columnName]})}
function getCorrName(corr_type){if(corr_type==='rho')return"Pearson's Correlation Coefficient";else if(corr_type==='ktau')return"Kendall's &#120591; Coefficient";else if(corr_type==='mic')return"Maximal Information Coefficient";else if(corr_type==='srho')return"Spearman's Rho"}
function getCorrMath(corr_type){if(corr_type==='rho')return"Pearson's Correlation Coefficient";else if(corr_type==='ktau')return" \\tau = \\frac{2}{n(n-1)} \\sum_{i=1}^{N} \\sum_{j=i}^{N} \\begin{cases} 1, & \\text{if } (x_i > x_j \\text{ and } y_j > y_j)  \\text{ or } (x_i < x_j \\text{ and } y_j < y_j)  \\\\0, &\\text{if } x_i = x_j \\text{ or } y_i = y_j  \\\\-1, &\\text{otherwise} \\end{cases}";else if(corr_type==='mic')return"Maximal Information Coefficient";else if(corr_type==='srho')return"Spearman's Rho"};function getAccounts(){const d1=$.Deferred(function(dfd){const ajaxAccountsGetAll=getAJAX(['accountsGetAll'],[],['accountsGetAll'],{},10000,1);ajaxAccountsGetAll.done(function(res){let accounts=JSON.parse(res).accountsGetAll;accounts=accounts.map(function(acct){acct.id=parseInt(acct.id);acct.nest_level=parseInt(acct.nest_level);acct.parent_id=acct.parent_id!==null?parseInt(acct.parent_id):null;if(acct.debit_effect==='1')acct.debit_effect=!0;else acct.debit_effect=!1;acct.bal=Number(acct.bal);acct.total_credit=Number(acct.total_credit);acct.total_debit=Number(acct.total_debit);return acct});let accountsByDepth=[];for(let depth=0;depth<10;depth++){accountsByDepth[depth]=[]}
for(let a=0;a<accounts.length;a++){accountsByDepth[accounts[a].nest_level-1].push(accounts[a])}
let accountsOrdered=accountsByDepth[0];for(let depth=1;depth<accountsByDepth.length;depth++){for(let a=0;a<accountsByDepth[depth].length;a++){for(let a2=0;a2<accountsOrdered.length;a2 ++){if(accountsOrdered[a2].id!==accountsByDepth[depth][a].parent_id)continue;accountsOrdered.splice(a2+1,0,accountsByDepth[depth][a])}}}
for(let i=0;i<accountsOrdered.length;i++){let j=1;let bal=0;let total_debit=0;let total_credit=0;if(accountsOrdered[i].has_child===!1){total_debit=accountsOrdered[i].total_debit||0;total_credit=accountsOrdered[i].total_credit||0}else{while(i+j<accountsOrdered.length&&accountsOrdered[i+j].nest_level>accountsOrdered[i].nest_level){if(accountsOrdered[i+j].has_child===!1){total_debit+=accountsOrdered[i+j].total_debit||0;total_credit+=accountsOrdered[i+j].total_credit||0}
j++}}
if(accountsOrdered[i].debit_effect===!0)debit_effect=1;else debit_effect=-1;bal=total_debit*debit_effect+total_credit*-1*debit_effect;accountsOrdered[i].bal=bal;accountsOrdered[i].total_debit=total_debit;accountsOrdered[i].total_credit=total_credit}
setData('accounts',accountsOrdered);console.log('accounts',accountsOrdered);dfd.resolve();return dfd.promise()})});return d1};function getHistory(accounts){const d1=$.Deferred(function(dfd){getAJAX(['transactionsGetAll'],[],['transactionsGetAll'],{},10000,1).done(function(res){let transactions=JSON.parse(res).transactionsGetAll;let dates=[...new Set(transactions.map(x=>x.date))];console.log('dates',dates);for(i=0;i<transactions.length;i++){transactions[i].credit=parseInt(transactions[i].credit);transactions[i].debit=parseInt(transactions[i].debit);transactions[i].id=parseInt(transactions[i].id);transactions[i].value=parseFloat(transactions[i].value)}
console.log('transactions',transactions);let chartData=[];for(d=0;d<dates.length;d++){date=dates[d];chartData[d]=[];for(a=0;a<accounts.length;a++){account=accounts[a];let total_debit=0;let total_credit=0;for(j=0;j<transactions.length;j++){if(new Date(transactions[j].date)>new Date(date))continue;if(transactions[j].debit!==account.id&&transactions[j].credit!==account.id)continue;if(transactions[j].debit===account.id)total_debit+=transactions[j].value;if(transactions[j].credit===account.id)total_credit+=transactions[j].value}
chartData[d].push({account:account.name,date:date,total_debit:total_debit,total_credit:total_credit,has_child:account.has_child,debit_effect:account.debit_effect,nest_level:account.nest_level})}}
for(d=0;d<dates.length;d++){let acct=chartData[d];for(let i=0;i<acct.length;i++){let j=1;let bal=0;let total_debit=0;let total_credit=0;if(acct[i].has_child===!1){total_debit=acct[i].total_debit||0;total_credit=acct[i].total_credit||0}else{while(i+j<acct.length&&acct[i+j].nest_level>acct[i].nest_level){if(acct[i+j].has_child===!1){total_debit+=acct[i+j].total_debit||0;total_credit+=acct[i+j].total_credit||0}
j++}}
if(acct[i].debit_effect===!0)debit_effect=1;else debit_effect=-1;bal=total_debit*debit_effect+total_credit*-1*debit_effect;acct[i].bal=bal}
chartData[d]=acct}
let chartData2={};for(let i=0;i<accounts.length;i++){chartData2[accounts[i].name]=[]}
for(let d=0;d<chartData.length;d++){for(let i=0;i<chartData[d].length;i++){chartData2[chartData[d][i].account].push([new Date(chartData[d][i].date).getTime(),chartData[d][i].bal])}}
console.log('history',chartData2);setData('history',chartData2)});dfd.resolve(data);return dfd.promise()});return d1};function buildGraph(history){let tsData=[];Object.keys(history).forEach(function(acctName){tsData.push({name:acctName,data:history[acctName],type:'line'})});console.log('tsData',tsData);let options={chart:{marginRight:10,backgroundColor:'rgba(225, 233, 240,.6)',plotBackgroundColor:'#FFFFFF',plotBorderColor:'#C0C0C0',height:400},title:{text:null},credits:{enabled:!1},exporting:{enabled:!1},navigator:{enabled:!1},scrollbar:{enabled:!1},rangeSelector:{selected:4,buttonTheme:{width:60},buttons:[{type:'month',count:1,text:'1mo'},{type:'month',count:3,text:'3mo'},{type:'ytd',count:1,text:'YTD'},{type:'year',count:1,text:'1Y'},{type:'all',text:'All'}]},xAxis:{type:'datetime',dateTimeLabelFormats:{day:"%b %e",week:"%b %e",month:"%b %Y"},gridLineWidth:1,},yAxis:{title:{text:'',},opposite:!0,min:0},tooltip:{useHTML:!0,formatter:function(){text='';for(i=0;i<this.points.length;i++){text+='<span style="font-weight:bold;color:'+this.points[i].series.color+'">'+this.points[i].series.name+': </span>'+this.points[i].y.toLocaleString('en-US',{style:'currency',currency:'USD',})+'</br>'}
return text},shared:!0},plotOptions:{series:{showInNavigator:!0,dataGrouping:{units:[['day',[1]]]}},line:{turboThreshold:0}},series:[]};for(i=0;i<tsData.length;i++){if(!['Equity','Retirement Investments','Mid-Term Investments','Liquid Assets'].includes(tsData[i].name))continue;options.series.push(tsData[i])}
console.log(options);new Highcharts.stockChart('tsChart',options);console.log($('#tsChart').highcharts())};$(document).ready(function(){(function(){$('#overlay').show();const dfdAccounts=getAccounts();$.when(dfdAccounts).done(function(){const accounts=getData('accounts');const dfdHistory=getHistory(accounts);$.when(dfdHistory).done(function(){const history=getData('history');createAccountsTable(accounts,history);buildGraph(history);$('#overlay').hide()})})})()});function createAccountsTable(accounts,history){const tbl=$('#tsTable');const today=new Date();const thirtyDaysAgo=new Date().setDate(today.getDate()-30);var tblData=[];if($.fn.DataTable.isDataTable(tbl)){tbl.DataTable().clear().destroy()}
$.each(accounts,function(i,row){let balThirtyDaysAgo=0;let changeThirtyDays=0;for(d=0;d<history[row.name].length;d++){if(history[row.name][d][0]<thirtyDaysAgo){balThirtyDaysAgo=d>0?history[row.name][d][1]:0}}
changeThirtyDays=row.bal-balThirtyDaysAgo;tblData.push([row.name+(row.has_child===!1?' <a style="font-size:14px;font-weight:bold" href="transactions?id='+row.id+'">&plus;</a>':''),changeThirtyDays.toLocaleString('en-US',{style:'currency',currency:'USD',}),1,row.bal.toLocaleString('en-US',{style:'currency',currency:'USD',})])});console.log("tblData",tblData);tbl.show().DataTable({data:tblData,iDisplayLength:15,dom:"<'row'<'col-sm-12 col-md-6'B><'col-sm-12 col-md-6'f>>"+"<'row'<'col-sm-12 px-0'tr>>"+"<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",buttons:['copy','csv','excel',],language:{search:"Search account name:",info:"_START_ - _END_ (_TOTAL_ total rows)"},columns:[{title:"Account Name"},{title:'Change - Last 30 Days',searchable:!1},{title:'Total Credits',searchable:!1},{title:'Current Bal',searchable:!1,type:'num-fmt'}],columnDefs:[{orderable:!1,targets:'_all'}],ordering:!1,paging:!1});var tblRows=tbl.find('tbody tr');for(var i=0;i<accounts.length;i++){tblRows.eq(i).find('td:first-child').css('padding-left',accounts[i].nest_level*15+'px')}
tbl.DataTable().buttons().container().appendTo('#tsTable_wrapper .col-md-6:eq(0)').children().removeClass('btn-secondary').addClass('btn-primary')}